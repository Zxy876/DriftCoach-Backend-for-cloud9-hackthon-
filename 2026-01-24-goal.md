 

DriftCoach Backend – Goal Document (Draft v0.1)

0. 项目定位（不可修改）

DriftCoach 是一个 post-hoc 决策分析系统，而非 agent / 聊天系统。
	•	系统不接受自由自然语言提问
	•	系统不“建议怎么打”，而是评估已经发生的决策迁移
	•	系统的所有事实输入均来自 GRID API 数据结构（或其 mock）
	•	LLM 不参与分析或决策，只用于数学结果 → 人类可理解隐喻

⸻

1. 本阶段目标（Goal）

在不接入真实 GRID API 的前提下，构建一个可运行的后端分析系统骨架，能够：
	1.	接受 GRID 风格的数据流（mock / fixture）
	2.	构建 State（状态快照）
	3.	识别 Decision Points（状态迁移点）
	4.	执行 Analysis Methods（规则 + 轻量 ML）
	5.	产出三类结构化结果：
	•	Player / Team Insights
	•	Match Review Agenda
	•	What-if Outcome Comparison
	6.	所有输出必须能回溯到数据与推理依据

⸻

2. 明确不做的事情（Scope Guard）

以下内容禁止实现（写进代码注释与 README）：
	•	❌ 自由自然语言问答接口
	•	❌ Agent / Planner / Tool-using LLM
	•	❌ LLM 直接生成分析结论
	•	❌ 实时比赛指导 / 在线决策
	•	❌ 端到端 ML 决策模型

⸻

3. 数据认知模型（对齐 GRID，但不依赖 GRID）

3.1 外部数据事实来源（只读）

系统假定存在以下 事实域（Fact Domains），其 schema 对齐 GRID API：
	•	Tournament
	•	Series
	•	Organization
	•	Team
	•	Player
	•	SeriesState (Live / Finished)
	•	TeamStatistics
	•	PlayerStatistics

⚠️ 当前阶段使用 Mock / Fixture 数据，字段需与 GRID schema 对齐。

⸻

3.2 内部核心数据结构（必须实现）

3.2.1 State（状态快照）
State 是系统的唯一事实入口。

最小 State Schema（示例）：

{
  "state_id": "S_001",
  "series_id": "SER_01",
  "game_index": 1,
  "timestamp": 24.15,
  "map": "Haven",
  "score_diff": -1,
  "econ_diff": -3200,
  "alive_diff": -2,
  "ult_diff": -1,
  "objective_context": "Drake",
  "phase": "MID_GAME"
}


⸻

3.2.2 Action（可选迁移动作）
Action 是 状态机中允许的迁移路径，不是用户输入。

{
  "action_id": "SAVE",
  "type": "ECON_DECISION"
}

示例 Action 集：
	•	SAVE / RETAKE
	•	FORCE / ECO
	•	CONTEST_OBJECTIVE / TRADE_OBJECTIVE

⸻

3.2.3 Transition（状态迁移）

{
  "from_state": "S_001",
  "action": "RETAKE",
  "outcome": "LOSS"
}


⸻

4. Analysis Runtime（核心）

4.1 Analysis Method Registry（必须）

系统维护一组显式、有限的分析方法。

每个方法必须声明：

method_name: free_death_impact
scope: player
requires:
  - kast_flag
  - round_result
trigger_conditions:
  sample_size >= 30
  free_death_rate >= 0.15
outputs:
  - derived_fact
  - confidence
  - applicable_actions

禁止：
	•	动态生成分析方法
	•	LLM 即兴推理分析逻辑

⸻

4.2 Derived Facts（中间事实层）

Derived Facts 是系统真正的“分析产物”，不是最终文本。

示例：

{
  "fact_type": "conditional_winrate",
  "condition": "free_death",
  "value": 0.78,
  "baseline": 0.52,
  "sample_size": 56
}


⸻

5. 三类系统输出（结构化）

5.1 Insight（个性化洞察）

{
  "type": "INSIGHT",
  "subject": "player:OXY",
  "claim": "Free deaths strongly correlate with round losses",
  "derived_facts": [...],
  "confidence": 0.78,
  "failure_conditions": ["ult_advantage >= 2"]
}


⸻

5.2 Review Agenda Item（宏观复盘）

{
  "type": "REVIEW_ITEM",
  "match_id": "M_001",
  "topic": "Econ cascade after failed force-buy",
  "states_involved": ["S_010", "S_011"],
  "evidence": [...]
}


⸻

5.3 What-if Outcome（假设结果）

{
  "type": "WHAT_IF",
  "state": "S_022",
  "actions": ["SAVE", "RETAKE"],
  "outcomes": {
    "SAVE": { "win_prob": 0.60 },
    "RETAKE": { "win_prob": 0.15 }
  },
  "confidence": 0.72
}


⸻

6. ML 使用边界（明确）

必须实现（ML-A）：
	•	State Similarity
	•	StandardScaler + PCA + kNN / cosine
	•	用于相似历史状态检索

可选实现（ML-B）：
	•	Logistic Regression / GBDT
	•	用于 P(outcome | state, action) 估计

禁止：
	•	深度学习
	•	强化学习
	•	黑箱 embedding

⸻

7. LLM 使用位置（冻结）

LLM 仅用于：
	•	将结构化数学结果解释为人类可理解的数学隐喻
	•	不接触原始数据
	•	不参与任何判断、触发、筛选

接口示例：

renderInsight(insight: StructuredInsight) -> string


⸻

8. API 接入策略（后置）
	•	当前阶段不接真实 GRID API
	•	使用 mock / fixture 数据驱动系统
	•	后续仅通过 Adapter 替换 State Builder 的数据源

⸻

9. 本阶段交付物（Definition of Done）

本阶段完成标准：
	•	可构建 State / Action / Transition
	•	至少 3 个 Analysis Method 可触发
	•	能生成三类结构化输出
	•	系统在数据不足时能明确拒绝输出
	•	无 agent / prompt / 即兴分析代码

⸻

 
 
一、DriftCoach Backend – 执行清单（Issue 级）

本清单是  你的唯一工作来源
不允许擅自合并 Issue、扩展 Scope 或引入新概念

⸻

Epic 0：工程约束与冻结（必须先完成）

Issue 0.1 — 写入项目约束声明

目标：防止 agent / prompt / API 先行

交付物
	•	README.md 中明确写入：
	•	非 agent
	•	非问答
	•	非 LLM 决策
	•	API 接入后置

验收标准
	•	README 中有明确的 “Out of Scope” 列表

⸻

Epic 1：核心世界观（State Machine）

Issue 1.1 — 定义 State Schema（最小可用）

目标：系统唯一事实入口

交付物
	•	core/state.py（或 state.ts）
	•	State 数据结构（含 id、比分、经济、人数、时间、phase）

验收标准
	•	所有分析函数只能接收 State 或 List[State]

⸻

Issue 1.2 — 定义 Action 枚举

目标：限定合法迁移路径

交付物
	•	core/action.py
	•	枚举：
	•	SAVE / RETAKE
	•	FORCE / ECO
	•	CONTEST / TRADE

验收标准
	•	Action 不可动态生成

⸻

Issue 1.3 — 定义 Transition 结构

目标：显式建模“决策发生”

交付物
	•	core/transition.py
	•	from_state / action / outcome

⸻

Epic 2：Derived Facts Pipeline

Issue 2.1 — 实现 DerivedFact 基类

目标：区分“算出来的事实”和“结论”

交付物
	•	core/derived_fact.py
	•	标准字段：
	•	fact_type
	•	value
	•	baseline
	•	sample_size

⸻

Issue 2.2 — 实现至少 2 种 Derived Fact

示例
	•	conditional_winrate
	•	econ_cascade_rate

验收标准
	•	不生成自然语言
	•	仅返回数值结构

⸻

Epic 3：Analysis Runtime（核心）

Issue 3.1 — AnalysisMethod Registry

目标：有限、显式、可审计

交付物
	•	analysis/registry.py
	•	Method 声明包含：
	•	scope
	•	requires
	•	trigger_conditions

⸻

Issue 3.2 — Trigger / Eligibility Engine

目标：不是“跑一通”，而是“该跑才跑”

交付物
	•	analysis/trigger.py
	•	能拒绝：
	•	样本不足
	•	状态不匹配

⸻

Issue 3.3 — 实现 3 个 Analysis Method（最小集）

建议
	1.	Free-death impact
	2.	Econ force-buy cascade
	3.	Objective contest failure

⸻

Epic 4：三类系统输出（结构化）

Issue 4.1 — Insight Schema

交付物
	•	outputs/insight.py
	•	包含：
	•	claim
	•	derived_facts
	•	confidence
	•	failure_conditions

⸻

Issue 4.2 — Review Agenda Item Schema

交付物
	•	outputs/review_item.py

⸻

Issue 4.3 — What-if Outcome Schema

交付物
	•	outputs/what_if.py

⸻

Epic 5：ML（严格受限）

Issue 5.1 — State Similarity（ML-A）

技术限定
	•	StandardScaler
	•	PCA
	•	kNN / cosine

交付物
	•	ml/state_similarity.py

⸻

Issue 5.2 —（可选）Outcome Probability Estimator

限定
	•	Logistic Regression 或 GBDT
	•	仅输出概率

⸻

Epic 6：LLM Renderer（最后做）

Issue 6.1 — Renderer 接口

交付物
	•	llm/renderer.py
	•	renderInsight / renderWhatIf

验收标准
	•	LLM 不接触 State / Raw Data

⸻

Epic 7：Mock 数据与端到端跑通

Issue 7.1 — Mock GRID Fixtures

交付物
	•	fixtures/
	•	对齐 GRID schema（Tournament / Series / Player / Stats）

⸻

Issue 7.2 — End-to-End Dry Run

目标
	•	从 mock → state → analysis → output

⸻

二、DriftCoach 后端目录结构 + 核心 Stub（v0.1）

这是推荐且冻结的目录结构
不允许随意加层级

driftcoach/
├── README.md
├── core/
│   ├── state.py
│   ├── action.py
│   ├── transition.py
│   └── derived_fact.py
│
├── analysis/
│   ├── registry.py
│   ├── trigger.py
│   └── methods/
│       ├── free_death.py
│       ├── econ_cascade.py
│       └── objective_fail.py
│
├── ml/
│   ├── state_similarity.py
│   └── outcome_model.py
│
├── outputs/
│   ├── insight.py
│   ├── review_item.py
│   └── what_if.py
│
├── llm/
│   └── renderer.py
│
├── fixtures/
│   ├── tournaments.json
│   ├── series.json
│   ├── players.json
│   ├── states.json
│   └── stats.json
│
└── main.py


⸻

核心 Stub 示例

core/state.py

from dataclasses import dataclass

@dataclass
class State:
    state_id: str
    map: str
    timestamp: float
    score_diff: int
    econ_diff: int
    alive_diff: int
    phase: str


⸻

analysis/registry.py

class AnalysisMethod:
    name: str
    scope: str

    def eligible(self, states) -> bool:
        raise NotImplementedError

    def run(self, states):
        raise NotImplementedError


⸻

outputs/insight.py

from dataclasses import dataclass

@dataclass
class Insight:
    subject: str
    claim: str
    derived_facts: list
    confidence: float
    failure_conditions: list


 