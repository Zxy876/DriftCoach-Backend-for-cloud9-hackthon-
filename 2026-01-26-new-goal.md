 

DriftCoach Backend — Central-Data Inference Engine & Evidence-Driven Analysis Layer

Engineering Goal v3.0 · 可执行 · 冻结版
（当前环境：仅 central-data；Series 查询字段受限，winner/score 未暴露；allSeries 可被限制分页；introspection 可能被阻挡）

⸻

0. 核心立场（冻结）

0.1 数据源立场
- 唯一数据源：`GRID_GRAPHQL_URL=https://api-op.grid.gg/central-data/graphql`
- 不接入其他 GRID endpoint（live/state/timeline/stats 扩展）。
- central-data = 官方允许的事实宇宙。

0.2 输入立场（极其重要）
- 唯一外部输入：`GRID_SERIES_ID`、`GRID_PLAYER_ID`（事实锚点）。
- 禁止：要求额外上下文 / 假设未暴露数据 / 伪造比赛或决策。

⸻

1. 系统本质（认知对齐）

1.1 我们在构建什么（不是玩笑）

DriftCoach 不是：
	•	比赛回放系统
	•	Stats Dashboard
	•	规则触发器

DriftCoach 是：

一个在 数据不完整条件下，
自动执行“教练式查询与对照推理”的推理系统

这与 “点球成金 / Moneyball” 方法论完全一致：
	•	不要求完美数据
	•	通过 对照、聚合、分布、趋势 得到判断
	•	明确区分：
可下结论 / 不可下结论

⸻

2. 架构重心迁移（v3.0）

从 v2.x → v3.0 的唯一实质变化

旧隐含假设	v3.0 明确立场
底层应有 games/rounds	central-data 是结构化聚合事实源
State ≈ 比赛过程	EvidenceState = 对照推理的事实切片
目标是“尽量触发分析器”	目标是“判断是否有资格触发分析器”


⸻

3. 系统职责拆分（冻结）

3.1 Inference Planner（推理规划器）
- 代码位置：`driftcoach/adapters/grid/planner.py`（已实现，需对齐本规范）。
- 职责：用最少查询最大化信息增益；允许失败；每步记录“为何查询/返回/缺失”。
- 必须：启动时（或首次）尝试 introspection；若被阻挡，回退到安全字段集。
- 字段安全集（当前 central-data 观测）：`id`, `startTimeScheduled`, `tournament { name }`, `format { name }`, `teams { baseInfo { id name } }`；其余字段按 introspection 结果择优。

⸻

3.2 Evidence Builder（证据构建层）
- 代码位置：`driftcoach/adapters/grid/to_state.py`（需升级到 v3.0 schema）。
- 职责：将 series/pool/聚合结果重组为可对照的 EvidenceState；不还原比赛过程，不构造虚拟事件。
- 生成策略（quota）：
	- Anchor 固定 4 条：FORMAT/TOURNAMENT/SCHEDULE/OPPONENT。
	- Series pool：每个 series 1 条 `SERIES_OUTCOME`（可判 outcome）或 1 条 `CONTEXT_ONLY`（不可判）。
	- Aggregated performance（待实现）：当 teamStatistics/playerStatistics 可用时，生成 `AGGREGATED_PERFORMANCE`（aggregation_level=team|player）。
	- 禁止复制同一条以凑数；允许 `<30` 时返回 insufficient_evidence/missing_outcome。

⸻

3.3 Analyzer（既有模块，不修改）
	•	Player Insight
	•	Post-match Review
	•	What-if Analysis

Analyzer 永远是消费者：
	•	只接收证据
	•	不负责补数据
	•	不对缺失事实负责

⸻

4. 交付物（必须）

4.1 Inference Planner（已部分实现，需收敛）
- 接口：`build_plan(series_id, player_id, max_steps=6) -> Plan`; `execute_plan(plan) -> EvidenceFacts`。
- Outcome 检测顺序（冻结）：`series.winner` → `series.teams[].score` → `series.result` → `series.outcome`；全缺失则 `outcome_field=NOT_FOUND`。
- Provenance：记录每步 query、字段、返回数量、信息增益/失败原因；缓存/memoize 同请求。
- 限制：`allSeries` 最多 200 edges，一次时间窗扩张（±90d→±180d）。

4.2 Evidence State Reconstruction（需升级）
- Schema（冻结）：
	```ts
	type EvidenceState = {
		index: number;
		evidence_type: "SERIES_OUTCOME" | "FORMAT_CONTEXT" | "TOURNAMENT_CONTEXT" | "OPPONENT_CONTEXT" | "SCHEDULE_CONTEXT" | "AGGREGATED_PERFORMANCE" | "CONTEXT_ONLY";
		outcome?: "WIN" | "LOSS";
		player_id: string;
		series_id?: string;
		team_ids?: string[];
		tournament?: string;
		format?: string;
		start_time?: string;
		action_tags: ActionTag[];
		provenance: { step_ids: string[]; fields_used: string[]; aggregation_level: "series" | "player" | "team" };
	};
	```
- 原则：缺失= None；不补齐触发；每条可追溯。

4.3 API 契约（/api/demo）
- `context.source` 必为 `grid|grid-fallback`；包含 `schema`（hasOutcome/outcome_field/missing）与 `evidence`（states/seriesPool/buckets/window/roster_proxy）。
- Analyzer 输出为空可接受；缺口需可解释。

⸻

5. 推理策略（Moneyball 落地）

5.1 Outcome 判定不是前提，而是结果
	•	Outcome 不是必然存在
	•	是否存在 outcome 本身就是系统结论的一部分

Outcome 探测优先级（冻结）：见 4.1；全缺失 ⇒ `schema_insufficient=true`。

⸻

5.2 Aggregation > Simulation
- 优先使用 central-data 可用的聚合：`teamStatistics` / `playerStatistics` / series count/wins/streaks / segment 聚合。
- 若字段缺失，记录 `aggregation_unavailable`，不得阻塞 pipeline。

⸻

6. Analysis Eligibility（分析资格，不强触发）

6.1 Insight
- 需 ≥20 可对照 EvidenceState + ≥2 对照桶 + outcome 或等价聚合信号；否则返回 `insufficient_evidence`（不造假）。阈值与现有分析器保持一致，日志打印“输入统计 + 未触发原因”。


⸻

6.2 Review
- Anchor 存在 outcome 或强聚合异常，且高权重场景（Bo3/Playoff/异常分布）。

⸻

6.3 What-if
- 仅在 Insight/Review 成立后；action 来自 action_tags；需标记 support_strength。

⸻

7. API 行为（冻结）
- `/api/demo` 返回包含：`context.source`, `schema{hasOutcome, outcome_field, missing}`, `evidence{states, seriesPool, buckets, window, roster_proxy}`。
- Analyzer 是否输出 ≠ 系统是否成功；缺口需在返回体中结构化说明。

⸻

8. 成功判定（v3.0）
- 成功 A：central-data 支撑；至少一分析模块产出；provenance 完整；日志/返回体自洽。
- 成功 B：证明当前 schema/样本不足；返回/日志解释缺口（outcome 缺失或样本不足）；不造假。

⸻

9. 失败判定（Fail Fast）
	•	伪造事件 / round / 决策
	•	为 demo 强行产出结论
	•	隐式假设 central-data “应该有”
	•	无法解释 EvidenceState 来源

⸻

10. 一句话（v3.0 定义）
DriftCoach 自动执行教练式推理，缺证据就理性沉默，而不是为 demo 造结论。

 